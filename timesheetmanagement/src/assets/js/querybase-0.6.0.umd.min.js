!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("querybase",["exports"],t):t(e.querybase=e.querybase||{})}(this,function(e){"use strict";function t(e,t){return new o(e,t)}var r={indexKey:function(){return"~~"},isCommonJS:function(){return"undefined"!=typeof module},isString:function(e){return"string"==typeof e||e instanceof String},isObject:function(e){return null!==e&&"object"==typeof e},hasMultipleCriteria:function(e){return e.length>1},createKey:function(e,t){return""+e+r.indexKey()+t},getPathFromRef:function(e){var t=3,r=e.toString().split("/");return r.slice(t,r.length).join("/")},merge:function(e,t){var r={};for(var n in e)r[n]=e[n];for(var n in t)r[n]=t[n];return r},keys:function(e){return Object.keys(e)},values:function(e){return Object.keys(e).map(function(t){return e[t]})},encodeBase64:function(e){return this.isCommonJS()?new Buffer(e).toString("base64"):window.btoa(e)},arraysToObject:function(e,t){var r={},n=0;return e.forEach(function(e){var o=t[n];r[e]=o,n++}),r},lexicographicallySort:function(e,t){return e.localeCompare(t)},getKeyIndexPositions:function(e){var t={};return e.forEach(function(e,r){return t[e]=r}),t},createSortedObject:function(e,t){var r={},n=this.getKeyIndexPositions(e),o=e.sort(this.lexicographicallySort);return o.forEach(function(e){var o=n[e];r[e]=t[o]}),r},sortObjectLexicographically:function(e){var t=this.keys(e),r=this.values(e);return this.createSortedObject(t,r)}},n=function(){function e(e){this.query=function(){return e}}return e.prototype.lessThan=function(e){return this.query().endAt(e)},e.prototype.greaterThan=function(e){return this.query().startAt(e)},e.prototype.equalTo=function(e){return this.query().equalTo(e)},e.prototype.startsWith=function(e){return this.query().startAt(e).endAt(e+"ï£¿")},e.prototype.between=function(e,t){return this.query().startAt(e).endAt(t)},e}(),o=function(){function e(e,t){var n=this;this.INDEX_LENGTH=3,this._assertFirebaseRef(e),this._assertIndexes(t),this._assertIndexLength(t),this.ref=function(){return e},this.indexOn=function(){return t.sort(r.lexicographicallySort)},this.key=this.ref().key,this.encodedKeys=function(){return n.encodeKeys(n.indexOn())}}return e.prototype._assertFirebaseRef=function(e){if(null===e||void 0===e||!e.on)throw new Error("No Firebase Database Reference provided in the Querybase constructor.")},e.prototype._assertIndexes=function(e){if(null===e||void 0===e)throw new Error("No indexes provided in the Querybase constructor. Querybase uses the indexOn() getter to create the composite queries for the where() method.")},e.prototype._assertIndexLength=function(e){if(e.length>this.INDEX_LENGTH)throw new Error("Querybase supports only "+this.INDEX_LENGTH+" indexes for multiple querying.")},e.prototype.set=function(e,t){var r=this.indexify(e);return this.ref().set(r,t)},e.prototype.update=function(e,t){var r=this.indexify(e);return this.ref().update(r)},e.prototype.push=function(e,t){if(!e)return this.ref().push();if(1===r.keys(e).length)return this.ref().push(e);var n=this.indexify(e),o=r.merge(n,e),i=this.ref().push();return i.set(o,t),i},e.prototype.remove=function(e){return this.ref().remove(e)},e.prototype.child=function(t,r){return new e(this.ref().child(t),r)},e.prototype._createQueryPredicate=function(e){var t=r.sortObjectLexicographically(e),n=r.keys(t),o=r.values(t);if(this._warnAboutIndexOnRule(),!r.hasMultipleCriteria(n))return{predicate:n[0],value:o[0]};var i=this.encodeKey(n.join(r.indexKey())),u=this.encodeKey(o.join(r.indexKey()));return{predicate:i,value:u}},e.prototype._createChildOrderedQuery=function(e){return new n(this.ref().orderByChild(e))},e.prototype._createEqualToQuery=function(e){return this.ref().orderByChild(e.predicate).equalTo(e.value)},e.prototype.where=function(e){if(r.isString(e))return this._createChildOrderedQuery(e);var t=this._createQueryPredicate(e);return this._createEqualToQuery(t)},e.prototype._createCompositeIndex=function(e,t,n){if(!Array.isArray(e))throw new Error("_createCompositeIndex expects an array for the first parameter: found "+e);if(0===e.length)throw new Error("_createCompositeIndex expect an array with multiple elements for the first parameter. Found an array with length of "+e.length);if(!r.isObject(t))throw new Error("_createCompositeIndex expects an object for the second parameter: found "+t);var o=e.slice(),i=o.shift();return n=n||{},o.forEach(function(e){var u="",s="";n[r.createKey(i,e)]=r.createKey(t[i],t[e]),o.forEach(function(e){u=r.createKey(u,e),s=r.createKey(s,t[e])}),n[i+u]=t[i]+s}),0!==o.length&&this._createCompositeIndex(o,t,n),n},e.prototype._encodeCompositeIndex=function(e){if(!r.isObject(e))throw new Error("_encodeCompositeIndex expects an object: found "+e.toString());var t=r.values(e),n=r.keys(e),o=this.encodeKeys(t),i=this.encodeKeys(n);return r.arraysToObject(i,o)},e.prototype.indexify=function(e){var t=this._createCompositeIndex(this.indexOn(),e),r=this._encodeCompositeIndex(t);return r},e.prototype.encodeKey=function(e){return"querybase"+r.indexKey()+r.encodeBase64(e)},e.prototype.encodeKeys=function(e){var t=this;return e.map(function(e){return t.encodeKey(e)})},e.prototype._warnAboutIndexOnRule=function(){var e=this.encodedKeys(),t='\n"'+r.getPathFromRef(this.ref())+'": {\n  ".indexOn": ['+r.keys(e).map(function(t){return'"'+e[t]+'"'}).join(", ")+"]\n}";console.warn("If you haven't yet, add this rule to drastically improve performance of your Realtime Database queries: \n "+t)},e}();e.ref=t,e.Querybase=o,e.QuerybaseQuery=n,e.QuerybaseUtils=r,Object.defineProperty(e,"__esModule",{value:!0})});